{% extends "base.html" %}

{% block title %}Adauga Produs - Garden of Records{% endblock %}
{% set active_page = 'add_product' %}

{% block content %}
<div class="dashboard-page">
  <div class="dashboard-header">
    <div>
      <h1>Adauga produs nou</h1>
      <p class="dashboard-subtitle">Completeaza detaliile pentru un produs nou in catalog.</p>
    </div>
    <div class="dashboard-actions">
      <a class="btn-secondary" href="{{ url_for('inventory') }}">Inventar</a>
    </div>
  </div>

    <div class="dashboard-card" id="itunesCard">
    <h3>Cauta album (Qobuz)</h3>
    <div class="inventory-toolbar" style="margin-bottom: 0;">
      <div class="inventory-filter-form" style="width: 100%;">
        <div class="inv-search-group">
          <input type="text" id="albumSearchInput" placeholder="Cauta album sau artist..." style="border:none; outline:none; font-size:0.95rem;">
        </div>
        <button class="btn-secondary" id="albumSearchBtn" type="button">Cauta</button>
      </div>
    </div>
    <div id="albumSearchResults" class="dashboard-list" style="margin-top: 1rem;"></div>
    <div class="itunes-pagination" id="itunesPagination"></div>
    <div id="albumTracks" class="dashboard-list" style="margin-top: 1rem; display: none;"></div>
  </div>

<div class="dashboard-card" style="max-width: 720px;">
    <form method="POST" action="{{ url_for('add_product') }}" class="add-product-form">
      <div class="form-group">
        <label for="title">Titlu produs *</label>
        <input type="text" id="title" name="title" required placeholder="Ex: Lover">
      </div>

      <div class="form-group">
        <label for="artist">Artist *</label>
        <input type="text" id="artist" name="artist" required placeholder="Ex: Taylor Swift">
      </div>

      <div class="form-group">
        <label for="category">Categorie *</label>
        <select id="category" name="category" required>
          <option value="">Selecteaza categorie</option>
          <option value="CD">CD</option>
          <option value="Vinyl">Vinyl</option>
          <option value="Merch">Merchandise</option>
        </select>
      </div>

      <div class="form-group">
        <label for="price">Pret (RON) *</label>
        <input type="number" id="price" min="0" inputmode="decimal" name="price" required step="0.01" placeholder="Ex: 99.99">
      </div>

      <div class="form-group">
        <label for="stock">Stoc (unitati) *</label>
        <input type="number" id="stock" inputmode="numeric" name="stock" required min="0" placeholder="Ex: 10">
      </div>

      <div class="form-group" id="imageGroup">
        <label for="image_url">URL imagine *</label>
        <input type="url" id="image_url" name="image_url" required placeholder="https://example.com/image.jpg">
      </div>

            <div class="form-group" id="audioUrlGroup">
        <label for="audio_url">Audio preview URL</label>
        <input type="text" id="audio_url" name="audio_url" class="filter-input" placeholder="https://audio-preview... sau qobuz:track_id|album_id">
      </div>

      <div class="form-group">
        <label for="description">Descriere produs</label>
        <textarea id="description" name="description" rows="5" class="filter-input" placeholder="Detalii despre album..."></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">Adauga produs</button>
        <a href="{{ url_for('inventory') }}" class="btn-secondary">Anuleaza</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block sidebar %}
  {% include "dashboard/_menu.html" %}
{% endblock %}

{% block extrajs %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('albumSearchInput');
    const btn = document.getElementById('albumSearchBtn');
    const results = document.getElementById('albumSearchResults');
    const pagination = document.getElementById('itunesPagination');
    const trackList = document.getElementById('albumTracks');
    const previewAudio = new Audio();
    previewAudio.preload = 'none';
    let selectedPreviewId = null;

    const titleEl = document.getElementById('title');
    const artistEl = document.getElementById('artist');
    const imageEl = document.getElementById('image_url');
    const descEl = document.getElementById('description');
    const audioEl = document.getElementById('audio_url');
    const categoryEl = document.getElementById('category');
    const itunesCard = document.getElementById('itunesCard');
    const imageGroup = document.getElementById('imageGroup');
    const audioUrlGroup = document.getElementById('audioUrlGroup');

    function renderResults(items) {
      results.innerHTML = '';
      if (trackList) {
        trackList.style.display = 'none';
        trackList.innerHTML = '';
      }
      if (!items.length) {
        results.innerHTML = '<p class="dashboard-subtitle">Nu am gasit rezultate.</p>';
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'dashboard-list-item';
        const thumb = item.artworkUrl100 || item.artworkUrl600 || '';
        const tag = item.collectionType ? item.collectionType.toUpperCase() : 'ALBUM';
        row.innerHTML = `
          <div class="album-result">
            <div class="album-thumb">${thumb ? `<img src="${thumb}" alt="" loading="lazy" decoding="async">` : ''}</div>
            <div>
              <strong>${item.collectionName}</strong>
              <div class="dashboard-subtitle">${item.artistName}</div>
              <span class="album-tag">${tag}</span>
            </div>
          </div>
          <button class="btn-secondary" type="button">Foloseste</button>
        `;
        row.querySelector('button').addEventListener('click', async () => {
          titleEl.value = item.collectionName || '';
          artistEl.value = item.artistName || '';
          const art = item.artworkUrl600 || item.artworkUrl100 || '';
          if (art) imageEl.value = art;
          if (audioEl) {
            audioEl.value = item.previewTrackId ? `qobuz:${item.previewTrackId}|${item.collectionId}` : '';
            selectedPreviewId = item.previewTrackId ? String(item.previewTrackId) : null;
          }
          const release = item.releaseDate ? String(item.releaseDate).slice(0, 10) : '';
          const genre = item.primaryGenreName || '';
          const descriptionBase = [
            `Album: ${titleEl.value}`,
            `Artist: ${artistEl.value}`,
            genre ? `Gen: ${genre}` : null,
            release ? `Lansat: ${release}` : null
          ].filter(Boolean);

          if (trackList) {
            trackList.style.display = '';
            trackList.innerHTML = '<p class="dashboard-subtitle">Se incarca piesele...</p>';
          }

          try {
            const details = await fetch(`/api/qobuz/album/${encodeURIComponent(item.collectionId)}`);
            const data = await details.json();
            const tracks = Array.isArray(data.tracks) ? data.tracks : [];

            const trackLines = tracks.map((t, idx) => `${idx + 1}. ${t.title || ''}`).filter(Boolean);
            const description = descriptionBase.slice();
            if (trackLines.length) {
              description.push('', 'Lista piese:', ...trackLines);
            }
            descEl.value = description.join('\n');

            if (trackList) {
              if (!tracks.length) {
                trackList.innerHTML = '<p class="dashboard-subtitle">Nu exista piese pentru acest album.</p>';
              } else {
                trackList.innerHTML = '';
                tracks.forEach((t, idx) => {
                  const trackRow = document.createElement('div');
                  trackRow.className = 'dashboard-list-item';
                  trackRow.dataset.trackId = t.id ? String(t.id) : '';
                  trackRow.innerHTML = `
                    <div class="album-result">
                      <div>
                        <strong>${idx + 1}. ${t.title || 'Piesa fara titlu'}</strong>
                      </div>
                    </div>
                    <div>
                      <button class="btn-secondary" type="button" data-action="play" aria-label="Play ${t.title || 'piesa'}">Play</button>
                      <button class="btn-secondary" type="button" data-action="select" aria-label="Seteaza preview ${t.title || 'piesa'}">Seteaza preview</button>
                    </div>
                  `;
                  const playBtn = trackRow.querySelector('[data-action="play"]');
                  const selectBtn = trackRow.querySelector('[data-action="select"]');
                  playBtn.addEventListener('click', async () => {
                    if (!t.id) return;
                    if (trackList) {
                      trackList.querySelectorAll('.dashboard-list-item').forEach((el) => el.classList.remove('is-playing'));
                      trackRow.classList.add('is-playing');
                    }
                    previewAudio.pause();
                    previewAudio.currentTime = 0;
                    previewAudio.onended = () => {
                      if (trackList) {
                        trackList.querySelectorAll('.dashboard-list-item').forEach((el) => el.classList.remove('is-playing'));
                      }
                    };
                    playBtn.disabled = true;
                    try {
                      const preview = await fetch(`/api/qobuz/preview/${encodeURIComponent(t.id)}`);
                      const previewData = await preview.json();
                      if (previewData && previewData.url) {
                        previewAudio.src = previewData.url;
                        await previewAudio.play();
                      }
                    } catch (err) {
                      if (trackList) {
                        trackList.insertAdjacentHTML(
                          'afterbegin',
                          '<p class="dashboard-subtitle">Nu am putut reda preview-ul.</p>'
                        );
                      }
                    } finally {
                      playBtn.disabled = false;
                    }
                  });
                  selectBtn.addEventListener('click', () => {
                    if (t.id) {
                      selectedPreviewId = String(t.id);
                      if (trackList) {
                        trackList.querySelectorAll('.dashboard-list-item').forEach((el) => el.classList.remove('is-selected'));
                        trackRow.classList.add('is-selected');
                      }
                    }
                    if (audioEl && t.id) {
                      audioEl.value = `qobuz:${t.id}|${item.collectionId}`;
                    }
                  });
                  trackList.appendChild(trackRow);
                });
                if (selectedPreviewId) {
                  trackList.querySelectorAll('.dashboard-list-item').forEach((el) => {
                    el.classList.toggle('is-selected', el.dataset.trackId === String(selectedPreviewId));
                  });
                }
              }
            }
          } catch (err) {
            descEl.value = descriptionBase.join('\n');
            if (trackList) {
              trackList.innerHTML = '<p class="dashboard-subtitle">Eroare la preluarea pieselor.</p>';
            }
          }
        });
        results.appendChild(row);
      });
    }

    function renderPagination(meta) {
      pagination.innerHTML = '';
      if (!meta || meta.total_pages <= 1) return;

      const createBtn = (label, page, disabled, active) => {
        const el = document.createElement(disabled ? 'span' : 'button');
        el.className = `page-btn${active ? ' active' : ''}${disabled ? ' disabled' : ''}`;
        el.textContent = label;
        if (!disabled) {
          el.addEventListener('click', () => doSearch(page));
        }
        return el;
      };

      pagination.appendChild(createBtn('Prev', meta.page - 1, meta.page <= 1));

      const window = 2;
      const start = Math.max(1, meta.page - window);
      const end = Math.min(meta.total_pages, meta.page + window);

      if (start > 1) {
        pagination.appendChild(createBtn('1', 1, false, meta.page === 1));
        if (start > 2) {
          const dots = document.createElement('span');
          dots.className = 'page-ellipsis';
          dots.textContent = '...';
          pagination.appendChild(dots);
        }
      }

      for (let p = start; p <= end; p += 1) {
        if (p === 1 || p === meta.total_pages) continue;
        pagination.appendChild(createBtn(String(p), p, false, meta.page === p));
      }

      if (end < meta.total_pages) {
        if (end < meta.total_pages - 1) {
          const dots = document.createElement('span');
          dots.className = 'page-ellipsis';
          dots.textContent = '...';
          pagination.appendChild(dots);
        }
        pagination.appendChild(createBtn(String(meta.total_pages), meta.total_pages, false, meta.page === meta.total_pages));
      }

      pagination.appendChild(createBtn('Next', meta.page + 1, meta.page >= meta.total_pages));
    }

    async function doSearch(page = 1) {
      const term = (input.value || '').trim();
      if (!term) return;
      results.innerHTML = '<p class="dashboard-subtitle">Se incarca...</p>';
      try {
        const res = await fetch(`/api/qobuz/search?term=${encodeURIComponent(term)}&page=${page}&per_page=10`);
        const data = await res.json();
        renderResults(Array.isArray(data.items) ? data.items : []);
        renderPagination(data);
      } catch (err) {
        results.innerHTML = '<p class="dashboard-subtitle">Eroare la cautare.</p>';
      }
    }

    btn.addEventListener('click', doSearch);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSearch(1);
      }
    });

    function toggleMerchFields() {
      const isMerch = categoryEl && categoryEl.value === 'Merch';
      if (itunesCard) itunesCard.style.display = isMerch ? 'none' : '';
      if (audioUrlGroup) audioUrlGroup.style.display = isMerch ? 'none' : '';
      if (audioEl && isMerch) audioEl.value = '';
      if (input) input.disabled = isMerch;
      if (btn) btn.disabled = isMerch;
      if (isMerch && results) results.innerHTML = '';
      if (isMerch && pagination) pagination.innerHTML = '';
    }

    if (categoryEl) {
      categoryEl.addEventListener('change', toggleMerchFields);
      toggleMerchFields();
    }
  });
</script>
{% endblock %}




















{% extends "base.html" %}

{% block title %}Procesare Comenzi - Garden of Records{% endblock %}
{% set active_page = 'process_orders' %}

{% block content %}
<div class="dashboard-page">
  <div class="dashboard-header">
    <div>
      <h1>Procesare comenzi</h1>
      <p class="dashboard-subtitle">Gestioneaza statusurile si expedierea.</p>
    </div>
    <div class="dashboard-actions">
      <a class="btn-primary" href="{{ url_for('inventory') }}">Inventar</a>
      <a class="btn-secondary" href="{{ url_for('dashboard') }}">Overview</a>
    </div>
  </div>

  <div class="dashboard-card">
    <div class="inventory-toolbar">
      <div class="inventory-filter-form">
        <div class="inv-search-group">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" data-filter-table="ordersTable" placeholder="Cauta ID comanda..." style="border:none; outline:none; margin-left:8px; font-size:0.9rem;">
        </div>
      </div>

      <div class="bulk-actions-panel" id="bulkActionsPanel">
        <span class="selected-count" id="selectedCount">0 selectate</span>
        <button type="button" class="btn-toolbar btn-success" id="btnBulkShip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon></svg>
          Marcheaza ca expediat
        </button>
      </div>
    </div>

    <div class="table-container-scroll">
      <table class="users-table" id="ordersTable">
        <thead>
          <tr>
            <th style="width: 30px; text-align: center;">
              <input type="checkbox" id="selectAll" class="custom-checkbox">
            </th>
            <th style="width: 60px;">ID</th>
            <th style="width: 120px;">Client</th>
            <th style="width: 90px;">Data</th>
            <th style="width: 100px;">Total</th>
            <th style="width: 140px;">Status</th>
            <th style="width: 80px; text-align: center;">Actiuni</th>
          </tr>
        </thead>
        <tbody>
          {% if orders and orders|length > 0 %}
            {% for order in orders %}
            <tr data-id="{{ order.id }}">
              <td style="text-align: center;">
                <input type="checkbox" class="custom-checkbox row-checkbox" value="{{ order.id }}">
              </td>
              <td>#{{ order.id|six_digit }}</td>
              <td><strong>U#{{ order.user_id|six_digit }}</strong></td>
              <td style="font-size: 0.85rem;">{{ order.date_created.strftime('%d.%m.%y') if order.date_created else '-' }}</td>
              <td style="font-weight: 600;">{{ "%.2f"|format(order.total_amount) }} RON</td>
              <td>
                <select class="status-select" data-id="{{ order.id }}">
                  <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>pending</option>
                  <option value="paid" {% if order.status == 'paid' %}selected{% endif %}>paid</option>
                  <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>processing</option>
                  <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>shipped</option>
                  <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>cancelled</option>
                </select>
              </td>
              <td style="text-align: center;">
                <button class="btn-icon btn-delete" data-id="{{ order.id }}" title="Sterge comanda">&times;</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: #999;">
                Nu exista comenzi de procesat.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {% include "dashboard/_pagination.html" %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const bulkPanel = document.getElementById('bulkActionsPanel');
    const selectedCountLabel = document.getElementById('selectedCount');
    const btnShip = document.getElementById('btnBulkShip');

    function updateToolbar() {
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      const count = checkedBoxes.length;
      selectedCountLabel.textContent = `${count} selectate`;
      if (count > 0) bulkPanel.classList.add('active');
      else bulkPanel.classList.remove('active');

      document.querySelectorAll('.row-checkbox').forEach(cb => {
        const tr = cb.closest('tr');
        if (cb.checked) tr.classList.add('selected-row');
        else tr.classList.remove('selected-row');
      });
    }

    document.querySelectorAll('.users-table tbody tr').forEach(row => {
      row.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox' && e.target.tagName.toLowerCase() !== 'select' && e.target.tagName.toLowerCase() !== 'button') {
          const cb = this.querySelector('.row-checkbox');
          if (cb) { cb.checked = !cb.checked; updateToolbar(); }
        }
      });
    });

    if (selectAll) {
      selectAll.addEventListener('change', function() {
        const isChecked = this.checked;
        rowCheckboxes.forEach(cb => cb.checked = isChecked);
        updateToolbar();
      });
    }

    rowCheckboxes.forEach(cb => cb.addEventListener('change', updateToolbar));

    if (btnShip) {
      btnShip.addEventListener('click', async function() {
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        if (checkedBoxes.length === 0) return;

        if (!confirm(`Expediezi ${checkedBoxes.length} comenzi?`)) return;

        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        try {
          for (const id of ids) {
            await fetch(`/api/orders/${id}/status`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: 'shipped' })
            });
          }
          alert('Comenzile au fost marcate ca expediate!');
          window.location.reload();
        } catch (err) {
          alert('Eroare la actualizarea comenzilor.');
          console.error(err);
        }
      });
    }

    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', async function() {
        const orderId = this.getAttribute('data-id');
        const newStatus = this.value;

        if (!confirm(`Schimbi statusul comenzii #${orderId} in "${newStatus}"?`)) {
          this.value = this.getAttribute('data-previous');
          return;
        }

        try {
          const res = await fetch(`/api/orders/${orderId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });
          const data = await res.json();

          if (data.success) {
            alert('Statusul a fost actualizat!');
            window.location.reload();
          } else {
            alert(`Eroare: ${data.error}`);
            this.value = this.getAttribute('data-previous');
          }
        } catch (err) {
          alert('Eroare server. Incearca din nou.');
          this.value = this.getAttribute('data-previous');
        }
      });
      select.setAttribute('data-previous', select.value);
    });

    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        const orderId = this.getAttribute('data-id');

        if (!confirm(`ATENTIE: Sigur vrei sa stergi comanda #${orderId}?`)) {
          return;
        }

        try {
          const res = await fetch(`/api/orders/${orderId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await res.json();

          if (data.success) {
            alert('Comanda a fost stearsa cu succes!');
            window.location.reload();
          } else {
            alert(`Eroare: ${data.error}`);
          }
        } catch (err) {
          console.error(err);
          alert('Eroare server. Incearca din nou.');
        }
      });
    });
  });
</script>
{% endblock %}

{% block sidebar %}
  {% include "dashboard/_menu.html" %}
{% endblock %}

{% extends "base.html" %}

{% block title %}Stocuri - Garden of Records{% endblock %}
{% set active_page = 'inventory' %}

{% block content %}
<div class="dashboard-page">
  <div class="dashboard-header">
    <div>
      <h1>Gestiune stocuri</h1>
      <p class="dashboard-subtitle">Selecteaza produsele pentru editare sau stergere.</p>
    </div>
    <div class="dashboard-actions">
      <a href="{{ url_for('add_product') }}" class="btn-primary">Adauga produs</a>
      <a href="{{ url_for('dashboard') }}" class="btn-secondary">Overview</a>
    </div>
  </div>

  <div class="dashboard-card">
    <div class="inventory-toolbar">
      <form method="GET" action="{{ url_for('inventory') }}" class="inventory-filter-form" id="filterForm">
        <div class="inv-search-group">
          <button type="submit">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          </button>
          <input type="text" name="q" data-filter-table="inventoryTable" placeholder="Cauta produse..." value="{{ values.q or '' }}">
        </div>
        <select name="category" onchange="this.form.submit()" class="inv-select">
          <option value="">Categorie...</option>
          <option value="CD" {% if values.category == 'CD' %}selected{% endif %}>CD</option>
          <option value="Vinyl" {% if values.category == 'Vinyl' %}selected{% endif %}>Vinyl</option>
          <option value="Merch" {% if values.category == 'Merch' %}selected{% endif %}>Merch</option>
        </select>
        {% if values.q or values.category %}
          <a href="{{ url_for('inventory') }}" style="color:#ef4444; font-weight:600; font-size:0.9rem;">Reset</a>
        {% endif %}
      </form>

      <div class="bulk-actions-panel" id="bulkActionsPanel">
        <span class="selected-count" id="selectedCount">0 selectate</span>
        <button type="button" class="btn-toolbar btn-neutral" id="btnBulkEdit" title="Editeaza selectia">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          Editeaza
        </button>

        <button type="button" class="btn-toolbar btn-danger" id="btnBulkDelete" title="Sterge selectia">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          Sterge
        </button>
      </div>
    </div>

    <div class="table-container-scroll">
      <table class="users-table inventory-table" id="inventoryTable">
        <thead>
          <tr>
            <th style="width: 40px; text-align: center;">
              <input type="checkbox" id="selectAll" class="custom-checkbox">
            </th>
            <th class="col-id" style="width: 60px;">ID</th>
            <th class="col-img" style="width: 60px;">Img</th>
            <th class="col-product">Produs</th>
            <th class="col-cat">Categorie</th>
            <th class="col-price">Pret</th>
            <th class="col-stock">Stoc</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr data-id="{{ product.id }}">
            <td style="text-align: center;">
              <input type="checkbox" class="custom-checkbox row-checkbox" value="{{ product.id }}">
            </td>
            <td class="col-id">#{{ product.id|six_digit }}</td>
            <td class="col-img">
              <img src="{{ product.image_url }}" loading="lazy" decoding="async" style="width:40px; height:40px; object-fit:cover; border-radius:6px; border:1px solid #eee; display:block;">
            </td>
            <td class="col-product">
              <span class="product-title-truncate" title="{{ product.title }}">{{ product.title }}</span>
              <div class="product-artist">{{ product.artist }}</div>
            </td>
            <td class="col-cat">
              <span style="background:#f4f4f5; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:600; color:#444;">
                {{ product.category }}
              </span>
            </td>
            <td class="col-price">{{ "%.2f"|format(product.price) }}</td>
            <td class="col-stock">
              {% if product.stock == 0 %}
                <span style="color:#ef4444; font-weight:bold; font-size:0.85rem;">Epuizat</span>
              {% elif product.stock < 5 %}
                <span style="color:#f59e0b; font-weight:bold; font-size:0.85rem;">{{ product.stock }}</span>
              {% else %}
                <span style="color:#10b981; font-weight:bold; font-size:0.85rem;">{{ product.stock }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% include "dashboard/_pagination.html" %}
  </div>
</div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const bulkPanel = document.getElementById('bulkActionsPanel');
    const selectedCountLabel = document.getElementById('selectedCount');
    const btnEdit = document.getElementById('btnBulkEdit');
    const btnDelete = document.getElementById('btnBulkDelete');

    function updateToolbar() {
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      const count = checkedBoxes.length;
      selectedCountLabel.textContent = `${count} selectate`;

      if (count > 0) {
        bulkPanel.classList.add('active');
      } else {
        bulkPanel.classList.remove('active');
      }

      document.querySelectorAll('.row-checkbox').forEach(cb => {
        const tr = cb.closest('tr');
        if (cb.checked) tr.classList.add('selected-row');
        else tr.classList.remove('selected-row');
      });

      if (count === 1) {
        btnEdit.disabled = false;
        btnEdit.title = "Editeaza produsul selectat";
      } else {
        btnEdit.disabled = true;
        btnEdit.title = "Selecteaza un singur produs pentru editare";
      }
    }

    const rows = document.querySelectorAll('.users-table tbody tr');
    rows.forEach(row => {
      row.addEventListener('click', function(e) {
        const targetTag = e.target.tagName.toLowerCase();
        const targetType = e.target.type;
        if (targetType !== 'checkbox' && targetTag !== 'a' && targetTag !== 'button' && targetTag !== 'svg' && targetTag !== 'path') {
          const cb = this.querySelector('.row-checkbox');
          if (cb) {
            cb.checked = !cb.checked;
            updateToolbar();
          }
        }
      });
    });

    selectAll.addEventListener('change', function() {
      const isChecked = this.checked;
      rowCheckboxes.forEach(cb => cb.checked = isChecked);
      updateToolbar();
    });

    rowCheckboxes.forEach(cb => {
      cb.addEventListener('change', updateToolbar);
    });

    btnEdit.addEventListener('click', function() {
      const checked = document.querySelector('.row-checkbox:checked');
      if (checked) {
        const id = checked.value;
        window.location.href = `/edit_product/${id}`;
      }
    });

    btnDelete.addEventListener('click', function() {
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkedBoxes.length === 0) return;

      if (confirm(`Sigur vrei sa stergi ${checkedBoxes.length} produse? Aceasta actiune este ireversibila.`)) {
        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        let promiseChain = Promise.resolve();

        ids.forEach(id => {
          promiseChain = promiseChain.then(() => {
            return fetch(`/delete_product/${id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
          });
        });

        promiseChain.then(() => {
          window.location.reload();
        }).catch(err => {
          alert('A aparut o eroare la stergere.');
          console.error(err);
        });
      }
    });
  });
</script>
{% endblock %}

{% block sidebar %}
  {% include "dashboard/_menu.html" %}
{% endblock %}


{% extends "base.html" %}

{% block title %}User Management - Garden of Records{% endblock %}

<!-- ACEASTĂ LINIE ESTE CRITICĂ: Golește sidebar-ul din dreapta definit în base.html -->
{% block sidebar %}{% endblock %}

{% block content %}
<style>
    /* 1. Layout Global Fix - Suprascriem Grid-ul din base.html */
    aside:not(.dashboard-sidebar) { display: none !important; }
    
    .grid-container, main { 
        display: block !important; 
        width: 100% !important; 
        max-width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important; 
    }
    
    .dashboard-container { 
        width: 100% !important; 
        max-width: 100% !important; 
        padding: 20px !important; 
        margin: 0 !important; 
    }

    /* 2. Toolbar & Checkbox Styles */
    .inventory-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 15px;
        background: #fff;
        padding: 12px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        min-height: 60px;
    }
    .inventory-filter-form { display: flex; gap: 10px; flex-grow: 1; align-items: center; }
    .bulk-actions-panel {
        display: none; align-items: center; gap: 10px; background: #f0f9ff;
        padding: 5px 15px; border-radius: 6px; border: 1px solid #bae6fd;
        margin-left: auto; animation: fadeIn 0.2s ease-out;
    }
    .bulk-actions-panel.active { display: flex; }
    .selected-count { font-weight: 600; color: #0284c7; margin-right: 10px; font-size: 0.9rem; }
    
    .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-color); border-radius: 4px; }
    
    /* Tabel Interactiv */
    .users-table tbody tr { cursor: pointer; transition: background-color 0.1s ease; }
    .users-table tbody tr:hover { background-color: #fafafa; }
    .users-table tbody tr.selected-row { background-color: #f0f9ff !important; }
    .users-table { width: 100%; border-collapse: collapse; table-layout: auto; }

    /* Butoane Toolbar */
    .btn-toolbar {
        padding: 6px 12px; border-radius: 6px; border: 1px solid transparent;
        font-size: 0.9rem; font-weight: 600; cursor: pointer;
        display: inline-flex; align-items: center; gap: 5px;
    }
    .btn-create { background: var(--success-color); color: white; border: none; }
    .btn-create:hover { background: #059669; }
    .btn-delete-bulk { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
    .btn-delete-bulk:hover { background: #dc2626; color: white; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="dashboard-overlay" id="dashboardOverlay"></div>

<div class="dashboard-container">
    <button class="dashboard-hamburger" id="dashboardHamburger">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <aside class="dashboard-sidebar" id="sidebarDrawer">
        <div class="user-info">
             <button id="closeDashboardBtn" style="position: absolute; right: 15px; top: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; display: none;">&times;</button>
            <h3>{{ current_user.username }}</h3>
            <span class="role-badge role-{{ current_user.role }}">{{ current_user.role }}</span>
        </div>
        <nav class="dashboard-nav">
            <a href="{{ url_for('dashboard') }}" class="dashboard-nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Overview
            </a>
            <a href="{{ url_for('manage_users') }}" class="dashboard-nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                User Management
            </a>
            <a href="{{ url_for('inventory') }}" class="dashboard-nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                Gestiune Stocuri
            </a>
            <a href="{{ url_for('index') }}" class="dashboard-nav-item back-btn">
                <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
                Înapoi la Magazin
            </a>
        </nav>
    </aside>

    <div class="dashboard-content">
        <div class="content-header">
            <div>
                <h1 style="margin: 0;">User Management</h1>
                <p style="color:#666; font-size:0.9rem;">Gestionează conturile utilizatorilor</p>
            </div>
        </div>
        
        <!-- TOOLBAR -->
        <div class="inventory-toolbar">
            <!-- FILTRE -->
            <div class="inventory-filter-form">
                <div class="inv-search-group" style="border: 1px solid #ccc; border-radius: 6px; padding: 5px 10px; display: flex; align-items: center; background: white;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" placeholder="Caută user sau email..." style="border:none; outline:none; margin-left:8px; font-size:0.9rem;">
                </div>
                
                <button id="openUserModal" class="btn-toolbar btn-create">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Utilizator Nou
                </button>
            </div>

            <!-- BULK ACTIONS -->
            <div class="bulk-actions-panel" id="bulkActionsPanel">
                <span class="selected-count" id="selectedCount">0 selectate</span>
                <button type="button" class="btn-toolbar btn-delete-bulk" id="btnBulkDelete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Șterge Selecția
                </button>
            </div>
        </div>
        
        <div class="table-container-scroll">
            <table class="users-table">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align: center;">
                            <input type="checkbox" id="selectAll" class="custom-checkbox">
                        </th>
                        <th>ID</th>
                        <th>Utilizator</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Dată Înreg.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-id="{{ user.id }}">
                        <td style="text-align: center;">
                            <!-- Ascundem checkbox-ul pentru userul curent ca să nu se șteargă singur -->
                            {% if user.id != current_user.id %}
                                <input type="checkbox" class="custom-checkbox row-checkbox" value="{{ user.id }}">
                            {% else %}
                                <span style="color:#ccc;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ user.id }}</td>
                        <td><strong>{{ user.username }}</strong></td>
                        <td>{{ user.email }}</td>
                        <td><span class="role-badge role-{{ user.role }}">{{ user.role|capitalize }}</span></td>
                        <td>{{ user.date_created.strftime('%d.%m.%Y') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Adăugare User -->
<div id="addUserModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <span class="close-user-modal" style="float: right; font-size: 1.5rem; cursor: pointer;">&times;</span>
        <h2 style="color: var(--primary-color); margin-bottom: 1.5rem; text-align: center;">Creează Cont Nou</h2>
        <form method="POST" action="{{ url_for('add_user') }}">
            <div class="form-group">
                <label>Utilizator</label>
                <input type="text" name="username" required class="filter-input">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required class="filter-input">
            </div>
            <div class="form-group">
                <label>Rol</label>
                <select name="role" class="filter-select" style="width: 100%;">
                    <option value="client">Client</option>
                    <option value="angajat">Angajat</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>Parolă</label>
                <input type="password" name="password" required class="filter-input">
            </div>
            <button type="submit" class="btn-primary" style="margin-top: 1rem;">Salvează</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Sidebar Logic ---
        const sidebar = document.getElementById('sidebarDrawer');
        const overlay = document.getElementById('sidebarOverlay');
        const btnToggle = document.getElementById('dashboardHamburger');
        const btnClose = document.getElementById('closeDashboardBtn');
        function toggleMenu() { 
            if(sidebar) sidebar.classList.toggle('active');
            if(overlay) overlay.classList.toggle('active'); 
        }
        if(btnToggle) btnToggle.onclick = toggleMenu; 
        if(btnClose) btnClose.onclick = toggleMenu; 
        if(overlay) overlay.onclick = toggleMenu;

        // --- Modal Logic ---
        const modal = document.getElementById('addUserModal');
        const btn = document.getElementById('openUserModal');
        const span = document.querySelector('.close-user-modal');
        if(btn) btn.onclick = () => modal.style.display = "block";
        if(span) span.onclick = () => modal.style.display = "none";
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

        // --- Checkbox & Bulk Logic ---
        const selectAll = document.getElementById('selectAll');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkPanel = document.getElementById('bulkActionsPanel');
        const selectedCountLabel = document.getElementById('selectedCount');
        const btnDelete = document.getElementById('btnBulkDelete');

        function updateToolbar() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedBoxes.length;
            selectedCountLabel.textContent = `${count} selectate`;
            
            if (count > 0) bulkPanel.classList.add('active');
            else bulkPanel.classList.remove('active');

            // Highlight
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                const tr = cb.closest('tr');
                if (cb.checked) tr.classList.add('selected-row');
                else tr.classList.remove('selected-row');
            });
        }

        // Click pe rând
        document.querySelectorAll('.users-table tbody tr').forEach(row => {
            row.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox' && e.target.tagName.toLowerCase() !== 'button') {
                    const cb = this.querySelector('.row-checkbox');
                    if (cb) {
                        cb.checked = !cb.checked;
                        updateToolbar();
                    }
                }
            });
        });

        selectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            rowCheckboxes.forEach(cb => cb.checked = isChecked);
            updateToolbar();
        });

        rowCheckboxes.forEach(cb => cb.addEventListener('change', updateToolbar));

        // Delete Action
        btnDelete.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkedBoxes.length === 0) return;
            if (confirm(`Sigur vrei să ștergi ${checkedBoxes.length} utilizatori?`)) {
                const ids = Array.from(checkedBoxes).map(cb => cb.value);
                let promiseChain = Promise.resolve();
                ids.forEach(id => {
                    promiseChain = promiseChain.then(() => fetch(`/delete_user/${id}`, { method: 'POST' }));
                });
                promiseChain.then(() => window.location.reload())
                            .catch(() => alert('Eroare la ștergere.'));
            }
        });
    });
</script>
{% endblock %}